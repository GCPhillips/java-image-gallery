/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package edu.au.cc.gallery.ui;

import edu.au.cc.gallery.data.User;

import static spark.Spark.*;

import spark.Response;
import spark.Request;
import spark.ModelAndView;
import spark.template.handlebars.HandlebarsTemplateEngine;

import java.util.HashMap;
import java.util.Map;

public class App {

    public static void main(String[] args) throws Exception {
        String portString = System.getenv("JETTY_PORT");
        if (portString == null || portString.equals(""))
            port(5000);
        else
            port(Integer.parseInt(portString));
    	addRoutes();
        Admin.addRoutes();
    }
    
    private static void addRoutes() {
        get("/sessionDemo", (req, res) -> sessionDemo(req, res));    
        get("/debugSession", (req, res) -> debugSession(req, res));    
        get("/login", (req, res) -> login(req, res));
        post("/login", (req, res) -> loginPost(req, res));
        before("/user/:username/*", (req, res) -> checkUser(req, res));
    }

    private static String login(Request req, Response resp) {
       Map<String, Object> model = new HashMap<>(); 
       return render(model, "login.hbs");       
    }

    private static String loginPost(Request req, Response resp) {
        try {
            String username = req.queryParams("username");
            User user = Admin.getUserDAO().getUserByUsername(username);
            if (user == null || ! user.getPassword().equals(req.queryParams("password")))
                resp.redirect("/login");
            req.session().attribute("user", username);
            resp.redirect("/debugSession");
        }
        catch (Exception ex) {
            return "[ERR]: " + ex.getMessage();
        }

        return "";
    }

    private static String sessionDemo(Request req, Response resp) {
        if (req.session().isNew()) {
            req.session().attribute("value",0); 
        }
        else {
            req.session().attribute("value", (int)req.session().attribute("value") + 1);   
        }

        return "<h1>" + req.session().attribute("value") + "</h1>";
    }

    private static String debugSession(Request req, Response resp) {
        StringBuffer sb = new StringBuffer();
        for(String key: req.session().attributes()) {
            sb.append(key + "->" + req.session().attribute(key) +"<br />");
        }
        return sb.toString();
    }

    private static boolean isUser(String username, String currentUser) {
        return username != null && currentUser != null && username.equals(currentUser);
    }

    private static void checkUser(Request req, Response res) {
        if (!isUser(req.session().attribute("user"), req.params("username"))) {
            res.redirect("/login");
            halt();
        }
    }

    public static String render(Map<String, Object> model, String templatePath) {
        return new HandlebarsTemplateEngine()
                .render(new ModelAndView(model, templatePath));
    }
}
